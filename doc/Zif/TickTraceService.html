<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Zif::TickTraceService
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Zif::TickTraceService";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (T)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Zif.html" title="Zif (module)">Zif</a></span></span>
     &raquo; 
    <span class="title">TickTraceService</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Zif::TickTraceService
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Zif::TickTraceService</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/lib/zif/services/tick_trace_service.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Zif::TickTrace is for performance tracing in your game.  It is set up and torn down for you if you use Zif::Game The idea is that you</p>
<ul><li>
<p>#reset_tick in the beginning of your tick, then</p>
</li><li>
<p>include Zif::Traceable and then use #mark to timestamp important areas in your code during a tick,</p>

<pre class="code ruby"><code class="ruby"><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_g'>g</span><span class='period'>.</span> <span class='id identifier rubyid_mark'>mark</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#my_method: Just did something!</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rparen'>)</span>
</code></pre>
</li><li>
<p>and finally #finish the tick</p>
</li></ul>

<p>If your tick takes longer than the time threshold, it will report the full trace info and highlight the section which took the most time to execute.  The game will begin to dip below 60fps if your tick takes longer than about 16ms, but the default threshold is 20ms so it should only notify you if something is really off.</p>

<p>Turn on running average calculation with @measure_averages==true</p>


  </div>
</div>
<div class="tags">
  

</div>



  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#averages-instance_method" title="#averages (instance method)">#<strong>averages</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute averages.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#last_tick_ms-instance_method" title="#last_tick_ms (instance method)">#<strong>last_tick_ms</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute last_tick_ms.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#measure_averages-instance_method" title="#measure_averages (instance method)">#<strong>measure_averages</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute measure_averages.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#slowest_avg_mark-instance_method" title="#slowest_avg_mark (instance method)">#<strong>slowest_avg_mark</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute slowest_avg_mark.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#slowest_mark-instance_method" title="#slowest_mark (instance method)">#<strong>slowest_mark</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute slowest_mark.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#slowest_max_mark-instance_method" title="#slowest_max_mark (instance method)">#<strong>slowest_max_mark</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute slowest_max_mark.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#time_threshold-instance_method" title="#time_threshold (instance method)">#<strong>time_threshold</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute time_threshold.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#clear_averages-instance_method" title="#clear_averages (instance method)">#<strong>clear_averages</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disable!-instance_method" title="#disable! (instance method)">#<strong>disable!</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#enable!-instance_method" title="#enable! (instance method)">#<strong>enable!</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#enabled%3F-instance_method" title="#enabled? (instance method)">#<strong>enabled?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#finish-instance_method" title="#finish (instance method)">#<strong>finish</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#format_ms-instance_method" title="#format_ms (instance method)">#<strong>format_ms</strong>(in_seconds)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>There&#39;s gotta be a better way to do this..</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(time_threshold = 0.02, measure_averages = false)  &#x21d2; TickTraceService </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>0.02 cooresponds to 20ms.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#last_label-instance_method" title="#last_label (instance method)">#<strong>last_label</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This is used to extract the name of the last #mark-ed code, useful for exception messages since we don&#39;t have line numbers.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mark-instance_method" title="#mark (instance method)">#<strong>mark</strong>(label)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#print_times-instance_method" title="#print_times (instance method)">#<strong>print_times</strong>(indented = 2)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset_tick-instance_method" title="#reset_tick (instance method)">#<strong>reset_tick</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(time_threshold = 0.02, measure_averages = false)  &#x21d2; <tt><span class='object_link'><a href="" title="Zif::TickTraceService (class)">TickTraceService</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>0.02 cooresponds to 20ms</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


19
20
21
22
23
24
25</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 19</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_time_threshold'>time_threshold</span><span class='op'>=</span><span class='float'>0.02</span><span class='comma'>,</span> <span class='id identifier rubyid_measure_averages'>measure_averages</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@time_threshold</span> <span class='op'>=</span> <span class='id identifier rubyid_time_threshold'>time_threshold</span>
  <span class='ivar'>@measure_averages</span> <span class='op'>=</span> <span class='id identifier rubyid_measure_averages'>measure_averages</span>
  <span class='ivar'>@enabled</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_clear_averages'>clear_averages</span>
  <span class='id identifier rubyid_reset_tick'>reset_tick</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="averages=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="averages-instance_method">
  
    #<strong>averages</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute averages.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_averages'>averages</span>
  <span class='ivar'>@averages</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="last_tick_ms=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="last_tick_ms-instance_method">
  
    #<strong>last_tick_ms</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute last_tick_ms.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_last_tick_ms'>last_tick_ms</span>
  <span class='ivar'>@last_tick_ms</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="measure_averages=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="measure_averages-instance_method">
  
    #<strong>measure_averages</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute measure_averages.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_measure_averages'>measure_averages</span>
  <span class='ivar'>@measure_averages</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="slowest_avg_mark=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="slowest_avg_mark-instance_method">
  
    #<strong>slowest_avg_mark</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute slowest_avg_mark.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_slowest_avg_mark'>slowest_avg_mark</span>
  <span class='ivar'>@slowest_avg_mark</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="slowest_mark=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="slowest_mark-instance_method">
  
    #<strong>slowest_mark</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute slowest_mark.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_slowest_mark'>slowest_mark</span>
  <span class='ivar'>@slowest_mark</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="slowest_max_mark=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="slowest_max_mark-instance_method">
  
    #<strong>slowest_max_mark</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute slowest_max_mark.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_slowest_max_mark'>slowest_max_mark</span>
  <span class='ivar'>@slowest_max_mark</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="time_threshold=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="time_threshold-instance_method">
  
    #<strong>time_threshold</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute time_threshold.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_time_threshold'>time_threshold</span>
  <span class='ivar'>@time_threshold</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="clear_averages-instance_method">
  
    #<strong>clear_averages</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47
48
49
50
51
52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 45</span>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_averages'>clear_averages</span>
  <span class='ivar'>@averages</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
    <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>min:</span>   <span class='const'>Float</span><span class='op'>::</span><span class='const'>INFINITY</span><span class='comma'>,</span>
      <span class='label'>max:</span>   <span class='op'>-</span><span class='const'>Float</span><span class='op'>::</span><span class='const'>INFINITY</span><span class='comma'>,</span>
      <span class='label'>avg:</span>   <span class='kw'>nil</span><span class='comma'>,</span>
      <span class='label'>count:</span> <span class='int'>0</span>
    <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="disable!-instance_method">
  
    #<strong>disable!</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 31</span>

<span class='kw'>def</span> <span class='id identifier rubyid_disable!'>disable!</span>
  <span class='ivar'>@enabled</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="enable!-instance_method">
  
    #<strong>enable!</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27
28
29</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 27</span>

<span class='kw'>def</span> <span class='id identifier rubyid_enable!'>enable!</span>
  <span class='ivar'>@enabled</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="enabled?-instance_method">
  
    #<strong>enabled?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


35
36
37</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 35</span>

<span class='kw'>def</span> <span class='id identifier rubyid_enabled?'>enabled?</span>
  <span class='ivar'>@enabled</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="finish-instance_method">
  
    #<strong>finish</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 84</span>

<span class='kw'>def</span> <span class='id identifier rubyid_finish'>finish</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_enabled?'>enabled?</span>

  <span class='id identifier rubyid_elapsed'>elapsed</span> <span class='op'>=</span> <span class='ivar'>@last_time</span> <span class='op'>-</span> <span class='ivar'>@start_time</span>
  <span class='ivar'>@last_tick_ms</span> <span class='op'>=</span> <span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='id identifier rubyid_elapsed'>elapsed</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='ivar'>@measure_averages</span>
    <span class='id identifier rubyid_avg_culprit'>avg_culprit</span><span class='comma'>,</span> <span class='id identifier rubyid_avg_culprit_time'>avg_culprit_time</span> <span class='op'>=</span> <span class='ivar'>@averages</span><span class='period'>.</span><span class='id identifier rubyid_max_by'>max_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid__label'>_label</span><span class='comma'>,</span> <span class='id identifier rubyid_time'>time</span><span class='op'>|</span> <span class='id identifier rubyid_time'>time</span><span class='lbracket'>[</span><span class='symbol'>:avg</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='ivar'>@slowest_avg_mark</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_avg_culprit'>avg_culprit</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='id identifier rubyid_avg_culprit_time'>avg_culprit_time</span><span class='lbracket'>[</span><span class='symbol'>:avg</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_max_culprit'>max_culprit</span><span class='comma'>,</span> <span class='id identifier rubyid_max_culprit_time'>max_culprit_time</span> <span class='op'>=</span> <span class='ivar'>@averages</span><span class='period'>.</span><span class='id identifier rubyid_max_by'>max_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid__label'>_label</span><span class='comma'>,</span> <span class='id identifier rubyid_time'>time</span><span class='op'>|</span> <span class='id identifier rubyid_time'>time</span><span class='lbracket'>[</span><span class='symbol'>:max</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='ivar'>@slowest_max_mark</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_culprit'>max_culprit</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='id identifier rubyid_max_culprit_time'>max_culprit_time</span><span class='lbracket'>[</span><span class='symbol'>:max</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_over_threshold'>over_threshold</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_elapsed'>elapsed</span> <span class='op'>&gt;</span> <span class='ivar'>@time_threshold</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_over_threshold'>over_threshold</span>

  <span class='id identifier rubyid_culprit'>culprit</span> <span class='op'>=</span> <span class='ivar'>@times</span><span class='period'>.</span><span class='id identifier rubyid_max_by'>max_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_time'>time</span><span class='op'>|</span> <span class='id identifier rubyid_time'>time</span><span class='lbracket'>[</span><span class='symbol'>:delta</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='ivar'>@slowest_mark</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_culprit'>culprit</span><span class='lbracket'>[</span><span class='symbol'>:label</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='id identifier rubyid_culprit'>culprit</span><span class='lbracket'>[</span><span class='symbol'>:delta</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_tick_details'>tick_details</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@last_tick_ms</span><span class='embexpr_end'>}</span><span class='tstring_content'> elapsed &gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='ivar'>@time_threshold</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> threshold, </span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_tick_details'>tick_details</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>longest step </span><span class='embexpr_beg'>#{</span><span class='ivar'>@slowest_mark</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>=</span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='int'>80</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Zif::TickTraceService: Slow tick. </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tick_details'>tick_details</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_print_times'>print_times</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="format_ms-instance_method">
  
    #<strong>format_ms</strong>(in_seconds)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>There&#39;s gotta be a better way to do this.. …all because &#39;%3.3f&#39; % 0.12 will print &#39;0.120&#39; instead of &#39;  0.120&#39;</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


126
127
128
129
130
131</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 126</span>

<span class='kw'>def</span> <span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='id identifier rubyid_in_seconds'>in_seconds</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ms'>ms</span> <span class='op'>=</span> <span class='id identifier rubyid_in_seconds'>in_seconds</span> <span class='op'>*</span> <span class='float'>1000.0</span>
  <span class='id identifier rubyid_whole_ms'>whole_ms</span> <span class='op'>=</span> <span class='id identifier rubyid_ms'>ms</span><span class='period'>.</span><span class='id identifier rubyid_floor'>floor</span>
  <span class='id identifier rubyid_dec'>dec</span> <span class='op'>=</span> <span class='id identifier rubyid_ms'>ms</span> <span class='op'>-</span> <span class='id identifier rubyid_whole_ms'>whole_ms</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%3d</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_whole_ms'>whole_ms</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.3f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_dec'>dec</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0.</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>ms</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="last_label-instance_method">
  
    #<strong>last_label</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This is used to extract the name of the last #mark-ed code, useful for exception messages since we don&#39;t have line numbers.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


120
121
122</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 120</span>

<span class='kw'>def</span> <span class='id identifier rubyid_last_label'>last_label</span>
  <span class='ivar'>@times</span><span class='op'>&amp;.</span><span class='id identifier rubyid_last'>last</span><span class='op'>&amp;.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='symbol'>:label</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="mark-instance_method">
  
    #<strong>mark</strong>(label)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 56</span>

<span class='kw'>def</span> <span class='id identifier rubyid_mark'>mark</span><span class='lparen'>(</span><span class='id identifier rubyid_label'>label</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_enabled?'>enabled?</span>

  <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='id identifier rubyid_delta'>delta</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span> <span class='op'>-</span> <span class='ivar'>@last_time</span>
  <span class='ivar'>@times</span> <span class='op'>&lt;&lt;</span> <span class='lbrace'>{</span>
    <span class='label'>label:</span>   <span class='id identifier rubyid_label'>label</span><span class='comma'>,</span>
    <span class='label'>delta:</span>   <span class='id identifier rubyid_delta'>delta</span><span class='comma'>,</span>
    <span class='label'>elapsed:</span> <span class='id identifier rubyid_t'>t</span> <span class='op'>-</span> <span class='ivar'>@start_time</span>
  <span class='rbrace'>}</span>
  <span class='ivar'>@last_time</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span>

  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='ivar'>@measure_averages</span>

  <span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:min</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:min</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_delta'>delta</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:max</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:max</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_delta'>delta</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>

  <span class='kw'>if</span> <span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:avg</span><span class='rbracket'>]</span>
    <span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:avg</span><span class='rbracket'>]</span> <span class='op'>=</span>
      <span class='lparen'>(</span><span class='lparen'>(</span><span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:avg</span><span class='rbracket'>]</span> <span class='op'>*</span> <span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:count</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_delta'>delta</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_fdiv'>fdiv</span><span class='lparen'>(</span><span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:count</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='int'>1</span><span class='rparen'>)</span>

  <span class='kw'>else</span>
    <span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:avg</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_delta'>delta</span>
  <span class='kw'>end</span>

  <span class='ivar'>@averages</span><span class='lbracket'>[</span><span class='id identifier rubyid_label'>label</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:count</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='int'>1</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="print_times-instance_method">
  
    #<strong>print_times</strong>(indented = 2)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


110
111
112
113
114
115
116</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 110</span>

<span class='kw'>def</span> <span class='id identifier rubyid_print_times'>print_times</span><span class='lparen'>(</span><span class='id identifier rubyid_indented'>indented</span><span class='op'>=</span><span class='int'>2</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_indent'>indent</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='id identifier rubyid_indented'>indented</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_indent'>indent</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%9s</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mark</span><span class='tstring_end'>&#39;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%9s</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>delta</span><span class='tstring_end'>&#39;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'> label</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@times</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_time'>time</span><span class='op'>|</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='id identifier rubyid_indented'>indented</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='id identifier rubyid_time'>time</span><span class='lbracket'>[</span><span class='symbol'>:elapsed</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_format_ms'>format_ms</span><span class='lparen'>(</span><span class='id identifier rubyid_time'>time</span><span class='lbracket'>[</span><span class='symbol'>:delta</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_time'>time</span><span class='lbracket'>[</span><span class='symbol'>:label</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reset_tick-instance_method">
  
    #<strong>reset_tick</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


39
40
41
42
43</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/lib/zif/services/tick_trace_service.rb', line 39</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_tick'>reset_tick</span>
  <span class='ivar'>@times</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@start_time</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='ivar'>@last_time</span> <span class='op'>=</span> <span class='ivar'>@start_time</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Sun Jan  3 16:59:27 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.6.3).
</div>

    </div>
  </body>
</html>